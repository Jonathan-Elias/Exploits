# Exploit Title: SonicWall SMA 10.2.1.0-17sv - Password Reset
# Description: Overwrite the persistent database, resulting in password reset on reboot.
# Shodan Dork: https://www.shodan.io/search?query=title%3A%22Virtual+Office%22+%22Server%3A+SonicWall%22
# Root Cause Analysis: https://attackerkb.com/topics/23t9VCbGzt/cve-2021-20034/rapid7-analysis?referrer=profile
# Vendor Homepage: https://www.sonicwall.com/
# Version: SMA 100 Series using 9.0.0.10-28sv, 10.2.0.7-34sv, and 10.2.1.0-17sv
# Tested on: SMA 500v using 9.0.0.10-28sv and 10.2.1.0-17sv
# CVE : CVE-2021-20034

EXPLORAÇÃO


O invasor só tem privilégios de usuário ‘nobody’. Isso é bastante limitante, já que quase tudo está sendo executado como root e a maioria dos arquivos requer privilégios de root para modificá-los. No entanto, o invasor pode ir atrás de alguns arquivos de configuração muito importantes.
O arquivo mais importante que o invasor pode excluir é o persist.db. Ele contém uma ampla variedade de definições de configuração do sistema. De usuários e senhas a personalizações e domínios do portal, o persist.db mantém todas essas informações entre inicializações e atualizações de firmware.
Então, o que acontece quando um invasor exclui persist.db?

curl -v --insecure "https://10.0.0.6/cgi-bin/handleWAFRedirect?hdl=../flash/etc/EasyAccess/var/conf/persist.db"

A resposta é um normal 200 OK, mas a interface da web fica completamente indisponível.
O que faz sentido, porque até mesmo acessar a página de destino requer que a interface da web alcance persist.db. Com persist.db ausente, o servidor HTTP cai em um estado de erro. Mas o mais importante é que o sistema não reinicia. O sistema simplesmente fica inativo em um estado ruim.
Na reinicialização, um persist.db padrão é gerado. O que significa que a conta do administrador com a senha padrão ( password) é criada. Isso permitiria que um invasor obtivesse acesso à interface da web, mas não parece que o invasor tenha meios de forçar a reinicialização por conta própria.
Um invasor também pode forçar o sistema a reinicializações infinitas. Isso pode ser feito excluindo os certificados SSL padrão.

curl -v --insecure "https://10.0.0.6/cgi-bin/handleWAFRedirect?hdl=../usr/src/EasyAccess/var/cert/server.crt"

curl -v --insecure "https://10.0.0.6/cgi-bin/handleWAFRedirect?hdl=../usr/src/EasyAccess/var/cert/server.key"

Quando o sistema for reinicializado, httpdfalhará ao iniciar devido à falta de certificados. Isso fará com que o monitor de software seja reinicializado.
Novamente, entrar no ciclo de reinicialização exige que alguém reinicie primeiro o servidor. E esse é o principal fator limitante da utilidade dessa vulnerabilidade. Certamente, o CVE-2021-20034 é perigoso e pode ser usado por atacantes destrutivos que simplesmente parecem ser caóticos. Mas, sem um mecanismo de reinicialização fácil de usar, a vulnerabilidade será difícil para os invasores aproveitarem para se transformar em redes corporativas, como vimos nas vulnerabilidades SonicWall anteriores.